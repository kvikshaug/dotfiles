#!/usr/bin/fish
# This file controls the contents of my dwm status bar
# It is set by the proc in .xinitrc every minute via 'xsetroot -name'

# Use a file because fish handles lines as array entries
# and I don't know how to handle that yet
set tmpfile (mktemp .dwmsb-tempfile.XXXXXXXX)

curl -u (~/.gc) --silent https://mail.google.com/mail/feed/atom | tr -d '\n' | awk -F '<entry>' '{for (i=2; i<=NF; i++) {print $i}}' > $tmpfile

# number of new mail
set newmailcount (cat -n $tmpfile | wc -l)

# display count and info if there are new mail
if test $newmailcount -gt 0
  # print count
  echo -n "$newmailcount"
  echo -n "M"

  # print name and subject of latest mail
  echo -n " "
  cat $tmpfile | cut -d\n -f 1 | sed -n "s/<title>\(.*\)<\/title.*name>\(.*\)<\/name>.*/\2: \1/p" | tr -d '\n'

  # separator
  echo -n " | "
end

/bin/rm $tmpfile

# load avg
cat /proc/loadavg | cut -d ' ' -f 1,2,3 | tr -d '\n'
echo -n " | "

# disk usage
df -h | grep sda4 | awk '{ print $3 "/" $4 "/" $5 }' | sed 's/G//g' | tr -d '\n'

# separator
echo -n " | "

# show date
echo -n (date +"%F %R")
