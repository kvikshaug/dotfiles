#!/usr/bin/fish
# This file controls the contents of my dwm status bar
# It is set by the proc in .dwmrc every minute via 'xsetroot -name'

# Use a file because fish handles lines as array entries
# and I don't know how to handle that yet
# TODO use mktemp
set tmpfile /tmp/currentnewmail

curl -u (~/.gc) --silent https://mail.google.com/mail/feed/atom | tr -d '\n' | awk -F '<entry>' '{for (i=2; i<=NF; i++) {print $i}}' > $tmpfile

# number of new mail
set newmailcount (cat -n /tmp/currentnewmail | wc -l)

# display count and info if there are new mail
if test $newmailcount -gt 0
  # print count
  echo -n "$newmailcount"
  echo -n "M"

  # print name and subject of latest mail
  echo -n " "
  cat /tmp/currentnewmail | cut -d\n -f 1 | sed -n "s/<title>\(.*\)<\/title.*name>\(.*\)<\/name>.*/\2: \1/p" | tr -d '\n'

  # separator
  echo -n " | "
end

/bin/rm $tmpfile

# disk usage
df -h | ag --nocolor sda1 | awk '{ print $3 " (" $5 ")" }' | tr -d '\n'

# separator
echo -n " | "

# show date
echo -n (date +"%F %R")
